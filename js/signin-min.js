"use strict";var matchingPatients=new MatchingPatients({});(function(matchingPatients){var SigninServicesView=Backbone.View.extend({model:SigninDetailedModel,tagName:"div",template:_.template($("#services-template").html()),className:"checkboxdivunselected",parent:"",events:{click:"markSelected"},initialize:function(options){if(options){this.parent=options.parent;this.listenTo(options.parent,"close:all",this.quit)}},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},markSelected:function(e){if(!this.model.selected){this.model.selected=true;this.parent.signin_model.attributes.services.push(this.model);this.$el.addClass("checkboxdivselected");this.$el.removeClass("checkboxdivunselected")}else{this.model.selected=false;var obj_index=this.parent.signin_model.attributes.services.indexOf(this.model);if(obj_index!=-1){this.parent.signin_model.attributes.services.splice(obj_index,1)}this.$el.addClass("checkboxdivunselected");this.$el.removeClass("checkboxdivselected")}}});var SigninView=Backbone.View.extend({model:SigninModel});var SigninAppView=Backbone.View.extend({el:".signincontainer",initialize:function(){this.bind("spinner",this.showSpinner,this);matchingPatients.on("reset",this.checkDuplicity,this)},events:{"keypress #lastname":"updateOnEnter","click #signinbtn":"signin","click #signoutbtn":"signout","click #finished":"commitSignin"},addAppointment:function(signinModel){var s_view=new SigninView({model:signinModel});$("#signin-section").append(view_appt.render().el)},checkDuplicity:function(){},spinnerTemplate:'<img src="images/spinner.gif" height="100">',showSpinner:function(){$("#buttonscontainer").html(this.spinnerTemplate)},hideSpinner:function(){$("#buttonscontainer").html(_.template($("#buttonscontainer-template").html()))},addAll:function(){this.$("#appointments-table").html($("#appointments-header").html());if($("#firstname_filter").val()||$("#lastname_filter").val()||$("#date_to").val()||$("#date_from").val()){var firstname_filter=$("#firstname_filter").val().toLowerCase();var lastname_filter=$("#lastname_filter").val().toLowerCase();var date_from_filter=$("#date_from").val();var date_to_filter=$("#date_to").val();var date_from=moment(date_from_filter,"YYYY-MM-DD").subtract(1,"d");var date_to=moment(date_to_filter,"YYYY-MM-DD");if((firstname_filter||lastname_filter||date_from_filter||date_to_filter)&&date_to.isValid()&&date_from.isValid()){var ac=appointmentsCollection.filter(function(appmodel){var appt_timedate=moment(appmodel.get("start_datetime").split(" ")[0],"DD-MMMM-YYYY");if((appmodel.get("firstname").toLowerCase()===firstname_filter||!firstname_filter)&&(appmodel.get("lastname").toLowerCase()===lastname_filter||!lastname_filter)&&appt_timedate.isBetween(date_from,date_to,"day")){return true}else{return false}});if(ac.length){_.each(ac,this.addAppointment)}else{this.$("#appointments-table").html('<tr><td bgcolor="white" border="0" align="center">0 appointments matching the above filter</tr></td>')}}}},reloadAppointments:function(){appointmentsCollection.fetch({reset:true,data:{from:appointmentsCollection.date_from,to:appointmentsCollection.date_to,page:appointmentsCollection.page,page_size:appointmentsCollection.page_size}})},updateOnEnter:function(e){if(e.which===13){this.signin(e);e.currentTarget.blur()}},updateFilterOnEnter:function(e){if(e.which===13&&e.currentTarget.id==="firstname_filter"||e.which===13&&e.currentTarget.id==="lastname_filter"){this.addAll();e.currentTarget.blur()}},showService:function(signin_detail_model){var signin_service_view=new SigninServicesView({model:signin_detail_model,parent:this});$("#services-inner-container").append(signin_service_view.render().el);$("#services-outer-container").show()},signin_model:{},signin_details:{},commitSignin:function(){var self=this;this.signin_model.save({},{success:function(model,response){var services_remaining_statement="";var these_services=self.signin_details.models;if(response.length>0){services_remaining_statement="<br>Services Summary<br>";for(var i=0;i<response.length;i++){if(response[i].remaining_appts>=0){services_remaining_statement+="<br>"+response[i].provider_name+": "+response[i].service_name+" "+response[i].remaining_appts+" remaining"}else{services_remaining_statement+="<br>"+response[i].provider_name+": "+response[i].service_name+" "+-response[i].remaining_appts+" had"}}}self.reportSuccess("Thank you for signing in.  Please see reception now"+services_remaining_statement);self.signin_model.unbind();self.clearForm()},error:function(){errorsdialog.show("issue connecting to database",true)}})},signin:function(e){this.trigger("spinner");var firstname=$("#firstname").val();var lastname=$("#lastname").val();var dob=$("#year").val()+"-"+$("#month").val()+"-"+$("#day").val();if(dob==="--"){dob=""}this.signin_model=new SigninModel({firstname:firstname,lastname:lastname,dob:dob,sig:"",services:[]});this.signin_details=new SigninDetailedCollection({});if(this.signin_model.isValid()){var signinView=new SigninView({model:this.signin_model});var self=this;matchingPatients=new MatchingPatients([],{firstname:firstname,lastname:lastname,dob:dob});matchingPatients.fetch({reset:true,data:{firstname:matchingPatients.firstname,lastname:matchingPatients.lastname,dob:matchingPatients.dob},success:function(){if(matchingPatients.length===0){errorsdialog.show("user not found",true);self.hideSpinner();return}else if(matchingPatients.length>1){self.showSpinner();$("#dob").addClass("datefieldshow");$("#dob").removeClass("datefieldhide");$("#datefieldmsg").addClass("datefieldmsgshow");$("#datefieldmsg").removeClass("datefieldhide");self.hideSpinner()}else if(e.type==="click"||e.which===13){var sigval=$("#signature");var data=sigval.jSignature("getData","svg");var data_str=data[1];var data_str_width=0;var data_str_height=0;data_str.split(" ").forEach(function(x){if(x.search("width")==0){data_str_width=x.slice(7,x.length-1)}if(x.search("height")==0){data_str_height=x.slice(8,x.lastIndexOf('"'))}});if(data_str.length<1e3&&(data_str.indexOf('width="0" height="0"')!==-1||data_str.length<500||data_str_width<100||data_str_height<50)){errorsdialog.show("oops... looks like you forgot to sign or the signature is too small.  Please try again",true);self.hideSpinner();return}else{var data_str=sigval.jSignature("getData","svgbase64");self.signin_model.attributes["sig"]=data_str[1];self.signin_model.attributes["client_id"]=matchingPatients.at(0).id;self.signin_details.fetch({data:{cid:matchingPatients.at(0).id},success:function(){if(self.signin_details.length>0){$("#services-inner-container").html("");$("#services-inner-container").append('<p style="color:red">select all the services for today');$("#signature").hide();$("#buttonscontainer").hide();self.signin_details.each(self.showService,self)}else{var committing=self.commitSignin.bind(self);committing()}self.hideSpinner()}})}}},error:function(){errorsdialog.show("issue connecting to database",true);this.hideSpinner();return}})}else{errorsdialog.show(this.signin_model.validationError,"#FF0000");this.hideSpinner();return}},reportSuccess:function(message){errorsdialog.show(message,false);$("#signature").jSignature("reset");document.forms["loginform"].reset();$("#datefieldmsg").removeClass("datefieldmsgshow");$("#datefieldmsg").addClass("datefieldhide");$("#dob").removeClass("datefieldshow");$("#dob").addClass("datefieldhide");$("#services-container").html("")},clearForm:function(){$("#services-inner-container").html("");$("#services-outer-container").hide();$("#buttonscontainer").show();$("#signature").show()},signout:function(e){var firstname=$("#firstname").val();var lastname=$("#lastname").val();var dob=$("#year").val()+"-"+$("#month").val()+"-"+$("#day").val();if(dob==="--"){dob=""}this.showSpinner();var signinModel=new SigninModel({firstname:firstname,lastname:lastname,dob:dob,sig:""});if(signinModel.isValid()){var signinView=new SigninView({model:signinModel});var self=this;matchingPatients=new MatchingPatients([],{firstname:firstname,lastname:lastname,dob:dob});matchingPatients.fetch({reset:true,data:{firstname:matchingPatients.firstname,lastname:matchingPatients.lastname,dob:matchingPatients.dob},success:function(){if(matchingPatients.length===0){errorsdialog.show("client not found",true);self.hideSpinner();return}else if(matchingPatients.length>1){$("#dob").addClass("datefieldshow");$("#dob").removeClass("datefieldhide");$("#datefieldmsg").addClass("datefieldmsgshow");$("#datefieldmsg").removeClass("datefieldhide");errorsdialog.show("Please enter your date of birth",false);$("#year").focus();self.hideSpinner()}else if(matchingPatients.models[0].get("signed_in")==false){errorsdialog.show("You are not signed in at the moment","#FF0000");self.hideSpinner();return}else if(e.type==="click"){var appointmentModel=new AppointmentModel({});appointmentModel.fetch({data:{id:matchingPatients.models[0].get("last_appointment_id")},success:function(){appointmentModel.save({end_datetime:function(m){return moment().format("YYYY-MM-DD HH:mm:ss")}(appointmentModel)},{success:function(){self.reportSuccess("Thank you for signing out");$("#signature").show()},error:function(){errorsdialog.show("issue connecting to database",true)}});self.hideSpinner()}})}},error:function(){errorsdialog.show("issue connecting to database",true);this.hideSpinner();return}})}else{errorsdialog.show(signinModel.validationError,true);this.hideSpinner();return}}});var SAV=new SigninAppView;return SAV})(matchingPatients);
