var RegisterModel=Backbone.Model.extend({url:"php/registerJS.php/",defaults:{firstname:"",lastname:"",birthdate:""},initialize:function(options){},validate:function(attrs,options){if(!attrs.lastname||!attrs.firstname||!attrs.dob){return"Firstname, Lastname and Date of Birth are all required fields"}if(attrs.dob&&!moment(attrs.dob,"YYYY-MM-DD",true).isValid()&&!moment(attrs.dob,"YYYY-M-DD",true).isValid()&&!moment(attrs.dob,"YYYY-M-D",true).isValid()){return"Birthdate is not a date"}}});var RegisterView=Backbone.View.extend({model:RegisterModel});var MatchingPatients=Backbone.Collection.extend({model:RegisterModel,wait:true,url:"php/matchPatients.php/",initialize:function(models,options){if(options){this.firstname=options.firstname;this.lastname=options.lastname;this.dob=options.dob}}});var RegisterAppView=Backbone.View.extend({el:".registercontainer",initialize:function(){matchingPatients.on("reset",this.checkDuplicity,this)},events:{"click #registerbtn":"register"},updateOnEnter:function(e){if(e.which===13){this.register();e.currentTarget.blur()}},register:function(e){var firstname=$("#firstname").val();var lastname=$("#lastname").val();var dob=$("#year").val()+"-"+$("#month").val()+"-"+$("#day").val();if(dob==="--"){dob=""}var registerModel=new RegisterModel({firstname:firstname,lastname:lastname,dob:dob});if(registerModel.isValid()){var registerView=new RegisterView({model:registerModel});var self=this;matchingPatients=new MatchingPatients([],{firstname:firstname,lastname:lastname,dob:dob});matchingPatients.fetch({reset:true,data:{firstname:matchingPatients.firstname,lastname:matchingPatients.lastname,dob:matchingPatients.dob},success:function(){if(matchingPatients.length>0){errorsdialog.show("A patient by that name and date of birth already exists",true);return}else if(e.type==="click"){registerModel.save({},{success:function(){self.reportSuccess("Registration complete.  Please sign in now")},error:function(){errorsdialog.show("issue connecting to database",true)}})}},error:function(){errorsdialog.show("issue connecting to database",true);return}})}else{errorsdialog.show(registerModel.validationError,"#FF0000");return}},reportSuccess:function(message){errorsdialog.show(message,false,"index_ls.html");document.forms["registerform"].reset()}});var matchingPatients=new MatchingPatients({});var registerappview=new RegisterAppView;
